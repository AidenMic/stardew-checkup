<!DOCTYPE html>
<html>
<head>
<title>Stardew Checkup</title>
<meta charset="UTF-8" />
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

<style type="text/css">
	html {
		min-height: 100%;
		background-attachment: fixed;
		background-color: #80a0f0; /* fallback color if gradients are not supported */
		background-image: -webkit-linear-gradient(top, #80a0f0, #c0ffff, #40c040); /* For Chrome 25 and Safari 6, iOS 6.1, Android 4.3 */
		background-image:    -moz-linear-gradient(top, #80a0f0, #c0ffff, #40c040); /* For Firefox (3.6 to 15) */
		background-image:      -o-linear-gradient(top, #80a0f0, #c0ffff, #40c040); /* For old Opera (11.1 to 12.0) */ 
		background-image:         linear-gradient(to bottom, #80a0f0, #c0ffff, #40c040); /* Standard syntax; must be last */
	}
	body {
		/* background-color: #ffe0b0; */
		margin: 15px;
		color: #603000;
	}
	a:link { color: #d06000; }
	a:visited { color: #804000; }
	a:hover,a:active { color: #ffa000; }
	.panel {
		background-color: #ffe0b0;
		padding: 8px;
		margin: 5px;
		border: 5px solid #804000;
		border-radius: 15px;
	}
	#input-container { display: none; }
	#output-container { display: none; }
	.error {
		font-weight: bold;
		font-size: 150%;
		color: #ff0000;
	}
	.path {
		font-family: monospace;
	}
	#footer {
		text-align: center;
	}
	.ach {
		font-style: italic;
	}
	.ach_yes {
		color: #004000;
	}
	.ach_yes:before {
		content: "\2714 ";
		margin-right: 3px;
	}
	.ach_no {
		color: #c00000;
	}
	.ach_no:before {
		content: "\2718 ";
		margin-right: 3px;
	}
	.ach_list {
		list-style: none;
		padding-left: 35px;
		margin-top: 0px;
	}
	.result:before {
		content: "\25c8 ";
		margin-right: 3px;
	}
	.result {
		padding-left: 15px;
	}
	.need:before {
		content: "! ";
		font-weight: bold;
		margin-right: 3px;
	}
	.need {
		margin-left: 38px;
	}
	.need ul{
		margin-left: 48px;
		margin-top: 0px;
	}
</style>
</head>
<body>
<div id="header" class="panel">
<h1>Stardew Checkup</h1>
<h2>About</h2>
<p>This script checks a <a href="http://stardewvalley.net/">Stardew Valley</a> save file for various achievements and milestones and
lets you know what is missing.</p>
<p>The newest version of the script is available on GitHub Pages at <a href="https://mouseypounds.github.io/stardew-checkup/">https://mouseypounds.github.io/stardew-checkup/</a> and the source code repository is <a href="https://github.com/MouseyPounds/stardew-checkup">https://github.com/MouseyPounds/stardew-checkup</a>.</p>

</div>

<div id="input-container" class="panel">
<h2>Save File</h2>
<p>Select a save file to check: <input type="file" id="file_select" /></p>
<p>Standard save file locations are:
<ul><li>Windows: <span class="path">%AppData%\StardewValley\Saves\</span></li>
<li>Mac OSX & Linux: <span class="path">~/.config/StardewValley/Saves/</span></li>
</ol>
</div>

<div id="output-container" class="panel">
<h2>Results</h2>
<output id="out"> </output>
</div>

<div id="changelog" class="panel">
<noscript><span class="error">Javascript appears to be unsupported by or disabled in your browser. Stardew Checkup will not work without it.</span></noscript>
<h2>Changelog</h2>
<ul>
<li>20 June 2017 - v1.0 - Initial Release
</ul>
</div>

<div id="footer" class="panel">
Stardew Valley resources: <a href="http://stardewvalley.net/">Website</a> || 
<a href="http://store.steampowered.com/app/413150/Stardew_Valley/">Steam Page</a> ||
<a href="https://www.gog.com/game/stardew_valley">GOG Page</a> ||
<a href="http://www.stardewvalleywiki.com/">Wiki</a> || 
<a href="http://community.playstarbound.com/index.php?forums/stardew-valley.72/">Forums</a> ||
<a href="https://www.reddit.com/r/StardewValley">Subreddit</a>
<br />
Stardew Checkup written by MouseyPounds. 
Stardew Valley developed by <a href="http://twitter.com/concernedape">ConcernedApe</a> and published by 
<a href="http://blog.chucklefish.org/about/">Chucklefish Games</a>.
</div>
<script>
window.onload=function(){
	// Check for the various File API support.
	if (!(window.File && window.FileReader)) {
		document.getElementById('out').innerHTML = '<span class="error">Fatal Error: Could not load the File & FileReader APIs</span>';
		return;
	}

	// Show input & output fields
	$(document.getElementById('input-container')).show();
	
	function handleFileSelect(evt) {
		var file = evt.target.files[0];
		var reader = new FileReader();

		reader.onload = function(e) {
			$(document.getElementById('changelog')).hide();
			$(document.getElementById('output-container')).show();
			var output = "";
			var xmlDoc = $.parseXML(e.target.result);

			output += '<h3>Summary</h3>\n';
			output += '<span class="result">Farmer ' + $(xmlDoc).find('player > name').text() + ' of '
				+ $(xmlDoc).find('player > farmName').text() + ' Farm</span><br />\n';
				
			output += '<h3>Money</h3>\n';
			var money = Number($(xmlDoc).find('player > totalMoneyEarned').text());
			output += '<span class="result">Total Earnings: ' + money + 'g</span><br /><ul class="ach_list">\n';
			output += '<li>'
			output += (money >= 15000) ? '<span class="ach_yes"><span class="ach">Greenhorn</span> Achievement (15K earnings) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Greenhorn</span> Achievement (15K earnings) Not Eligible</span> -- need ' + (15000-money) + 'g more>';
			output += '</li>\n<li>';
			output += (money >= 50000) ? '<span class="ach_yes"><span class="ach">Cowpoke</span> Achievement (50K earnings) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Cowpoke</span> Achievement (50K earnings) Not Eligible</span> -- need ' + (50000-money) + 'g more';
			output += '</li>\n<li>';
			output += (money >= 250000) ? '<span class="ach_yes"><span class="ach">Homesteader</span> Achievement (250K earnings) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Homesteader</span> Achievement (250K earnings) Not Eligible</span> -- need ' + (250000-money) + 'g more';
			output += '</li>\n<li>';
			output += (money >= 1000000) ? '<span class="ach_yes"><span class="ach">Millionaire</span> Achievement (1M earnings) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Millionaire</span> Achievement (1M earnings) Not Eligible</span> -- need ' + (1000000-money) + 'g more';
			output += '</li>\n<li>';
			output += (money >= 10000000) ? '<span class="ach_yes"><span class="ach">Legend</span> Achievement (10M earnings) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Legend</span> Achievement (10M earnings) Not Eligible</span> -- need ' + (10000000-money) + 'g more';
			output += '</li></ul>\n';

			output += '<h3>Social</h3>\n';
			var count_5h = 0;
			var count_10h = 0;
			$(xmlDoc).find('player > friendships > item').each(function() {
				var who = $(this).find('key > string').text();
				var num = $(this).find('value > ArrayOfInt > int').first().text();
				if (num >= 2500) { count_10h++; }
				if (num >= 1250) { count_5h++; }
				// TODO: check for maxed out hearts on everyone
			});
			output += '<span class="result">Friends with 5+ hearts: ' + count_5h + '</span><ul class="ach_list">\n';
			output += '<li>'
			output += (count_5h >= 1) ? '<span class="ach_yes"><span class="ach">A New Friend</span> Achievement (1 with 5&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">A New Friend</span> Achievement (1 with 5&#x2764;) Not Eligible</span> -- need ' + (1-count_5h) + ' more';
			output += '</li>\n<li>';
			output += (count_5h >= 4) ? '<span class="ach_yes"><span class="ach">Cliques</span> Achievement (4 with 5&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Cliques</span> Achievement (4 with 5&#x2764;) Not Eligible</span> -- need ' + (4-count_5h) + ' more>\n';
			output += '</li>\n<li>';
			output += (count_5h >= 10) ? '<span class="ach_yes"><span class="ach">Networking</span> Achievement (10 with 5&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Networking</span> Achievement (10 with 5&#x2764;) Not Eligible</span> -- need ' + (10-count_5h) + ' more';
			output += '</li>\n<li>';
			output += (count_5h >= 20) ? '<span class="ach_yes"><span class="ach">Popular</span> Achievement (20 with 5&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Popular</span> Achievement (20 with 5&#x2764;) Not Eligible</span> -- need ' + (20-count_5h) + ' more';
			output += '</li></ul>\n';
			output += '<span class="result">Friends with 10+ hearts: ' + count_10h + '</span><ul class="ach_list">\n';
			output += '<li>'
			output += (count_10h >= 1) ? '<span class="ach_yes"><span class="ach">Best Friends</span> Achievement (1 with 10&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Best Friends</span> Achievement (1 with 10&#x2764;) Not Eligible</span> -- need ' + (1-count_10h) + ' more';
			output += '</li>\n<li>';
			output += (count_10h >= 8) ? '<span class="ach_yes"><span class="ach">The Beloved Farmer</span> Achievement (8 with 10&#x2764;) Eligible</span>' :
				'<span class="ach_no"><span class="ach">The Beloved Farmer</span> Achievement (8 with 10&#x2764;) Not Eligible</span> -- need ' + (8-count_10h) + ' more';
			output += '</li></ul>\n';
			
			var spouse = '(None)';
			var needs = [];
			var count = 0;
			var result = $(xmlDoc).find('player > spouse')
			if (result.length > 0) {
				spouse = result.text();
				count++;
			} else {
				needs.push('Spouse');
			}
			output += '<span class="result">Spouse: ' + spouse + '</span><br />\n';
			var children = '(None)';
			var child_name = [];
			// not sure how to get the [] attribute selectors to recognize xsi:type as valid attribute name, so working around it
			result = $(xmlDoc).find('locations > GameLocation > Characters > NPC').each(function() {
				if ( $(this).attr('xsi:type') == 'Child' ) {
					count++;
					child_name.push($(this).find('name').text());
				}
			});
			if (child_name.length) {
				children = child_name.join(', ');
				if (child_name.length == 1) { 
					needs.push("1 child");
				}
			} else {
				needs.push("2 children");
			}
			output += '<span class="result">Children: ' + children + '</span><ul class="ach_list"><li>\n';
			output += (count >= 3) ? '<span class="ach_yes"><span class="ach">Full House</span> Achievement (Married + 2 kids) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Full House</span> Achievement (Married + 2 kids) Not Eligible</span> -- need ' + needs.join('; ');
			output += '</li></ul>\n';

			//TODO: Joja vs CC.
			// CC bundles: locations > GameLocation [attr('xsi:type') == 'CommunityCenter'] > bundles (individual) & areasComplete
			
			output += '<h3>Cooking</h3>\n';
			// cookingRecipes is keyed by name, but recipesCooked is keyed by ObjectInformation ID.
			// Also, some cookingRecipes names are different from the names in ObjectInformation (e.g. Cookies vs Cookie)
			var recipeIDs = {
				194:"Fried Egg",
				195:"Omelet",
				196:"Salad",
				197:"Cheese Cauliflower",
				198:"Baked Fish",
				199:"Parsnip Soup",
				200:"Vegetable Medley",
				201:"Complete Breakfast",
				202:"Fried Calamari",
				203:"Strange Bun",
				204:"Lucky Lunch",
				205:"Fried Mushroom",
				206:"Pizza",
				207:"Bean Hotpot",
				208:"Glazed Yams",
				209:"Carp Surprise",
				210:"Hashbrowns",
				211:"Pancakes",
				212:"Salmon Dinner",
				213:"Fish Taco",
				214:"Crispy Bass",
				215:"Pepper Poppers",
				216:"Bread",
				218:"Tom Kha Soup",
				219:"Trout Soup",
				220:"Chocolate Cake",
				221:"Pink Cake",
				222:"Rhubarb Pie",
				223:"Cookie",
				224:"Spaghetti",
				225:"Fried Eel",
				226:"Spicy Eel",
				227:"Sashimi",
				228:"Maki Roll",
				229:"Tortilla",
				230:"Red Plate",
				231:"Eggplant Parmesan",
				232:"Rice Pudding",
				233:"Ice Cream",
				234:"Blueberry Tart",
				235:"Autumn's Bounty",
				236:"Pumpkin Soup",
				237:"Super Meal",
				238:"Cranberry Sauce",
				239:"Stuffing",
				240:"Farmer's Lunch",
				241:"Survival Burger",
				242:"Dish O' The Sea",
				243:"Miner's Treat",
				244:"Roots Platter",
				456:"Algae Soup",
				457:"Pale Broth",
				604:"Plum Pudding",
				605:"Artichoke Dip",
				606:"Stir Fry",
				607:"Roasted Hazelnuts",
				608:"Pumpkin Pie",
				609:"Radish Salad",
				610:"Fruit Salad",
				611:"Blackberry Cobbler",
				612:"Cranberry Candy",
				618:"Bruschetta",
				648:"Coleslaw",
				649:"Fiddlehead Risotto",
				651:"Poppyseed Muffin",
				727:"Chowder",
				728:"Fish Stew",
				729:"Escargot",
				730:"Lobster Bisque",
				731:"Maple Bar",
				732:"Crab Cakes",
			};
			var recipe_count = 71; // Yes, this is hardcoded since .length doesn't work on the object
			var recipeTranslate = {
				"Cheese Cauli.":"Cheese Cauliflower",
				"Cookies":"Cookie",
				"Cran. Sauce":"Cranberry Sauce",
				"Dish o' The Sea":"Dish O' The Sea",
				"Eggplant Parm.":"Eggplant Parmesan",
				"Vegetable Stew":"Vegetable Medley",
			};
			var known = {};
			var known_count = 0;
			var crafted = {};
			var craft_count = 0;
			
			$(xmlDoc).find('player > cookingRecipes > item').each(function() {
				var id = $(this).find('key > string').text();
				var num = $(this).find('value > int').text();
				if (id in recipeTranslate) {
					id = recipeTranslate[id];
				}
				known[id] = num;
				known_count++;
			});
			$(xmlDoc).find('player > recipesCooked > item').each(function() {
				var id = $(this).find('key > int').text();
				var num = $(this).find('value > int').text();
				// Do we need to check that num>0?
				crafted[recipeIDs[id]] = num;
				craft_count++;
			});
			
			output += '<span class="result">Knows  ' + known_count + ' recipes and has cooked ' + craft_count + 
				' of them (out of ' + recipe_count + ' total)</span><ul class="ach_list">\n';
			output += '<li>'
			output += (craft_count >= 10) ? '<span class="ach_yes"><span class="ach">Cook</span> Achievement (10 recipes cooked) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Cook</span> Achievement (10 recipes cooked) Not Eligible</span> -- need ' + (10-craft_count) + ' more';
			output += '</li>\n<li>';
			output += (craft_count >= 25) ? '<span class="ach_yes"><span class="ach">Sous Chef</span> Achievement (25 recipes cooked) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Sous Chef</span> Achievement (25 recipes cooked) Not Eligible</span> -- need ' + (25-craft_count) + ' more';
			output += '</li>\n<li>';
			output += (craft_count >= recipe_count) ? '<span class="ach_yes"><span class="ach">Gourmet Chef</span> Achievement (all recipes cooked) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Gourmet Chef</span> Achievement (all recipes cooked) Not Eligible</span> -- need ' + (recipe_count-craft_count) + ' more';
			output += '</li></ul>\n';
			// We are assuming it is impossible to craft something without knowing the recipe.
			if (craft_count < recipe_count) {
				var need_k = [];
				var need_c = [];
				for (var id in recipeIDs) {
					var r = recipeIDs[id];
					if (!known.hasOwnProperty(r)) {
						need_k.push('<li>' + r + '</li>');
					} else if (!crafted.hasOwnProperty(r)) {
						need_c.push('<li>' + r + '</li>');
					} 
				}
				// TODO: Test knowing all recipes but not having crafted them in both cooking and crafting
				output += '<span class="need">Left to cook:<ul>'
				if (need_c.length > 0) {
					output += '<li>Known Recipes<ol>' + need_c.sort().join('') + '</ol></li>\n';
				}
				if (need_k.length > 0) {
					output += '<li>Unknown Recipes<ol>' + need_k.sort().join('') + '</ol></li>\n';
				}

				output += '</ul></span>\n';
			}

			output += '<h3>Crafting</h3>\n';
			// Manually listing all crafting recipes in the order they appear on http://stardewvalleywiki.com/Crafting
			// Also, once again there is a text mismatch
			var recipes = [	"Cherry Bomb", "Bomb", "Mega Bomb",
							"Gate", "Wood Fence", "Stone Fence", "Iron Fence", "Hardwood Fence",
							"Sprinkler", "Quality Sprinkler", "Iridium Sprinkler",
							"Mayonnaise Machine", "Bee House", "Preserves Jar", "Cheese Press", "Loom", "Keg", "Oil Maker", "Cask",
							"Basic Fertilizer", "Quality Fertilizer", "Speed-Gro", "Deluxe Speed-Gro",
								"Basic Retaining Soil", "Quality Retaining Soil",
							"Wild Seeds (Sp)", "Wild Seeds (Su)", "Wild Seeds (Fa)", "Wild Seeds (Wi)", "Ancient Seeds",
							"Wood Floor", "Straw Floor", "Weathered Floor", "Crystal Floor", "Stone Floor",
								"Wood Path", "Gravel Path", "Cobblestone Path", "Stepping Stone Path", "Crystal Path",
							"Spinner", "Trap Bobber", "Cork Bobber", "Treasure Hunter", "Dressed Spinner", "Barbed Hook",
								"Magnet", "Bait", "Wild Bait", "Crab Pot",
							"Sturdy Ring", "Warrior Ring", "Ring of Yoba", "Iridium Band",
							"Field Snack", "Life Elixir", "Oil of Garlic",
							"Torch", "Campfire", "Wooden Brazier", "Stone Brazier", "Gold Brazier", "Carved Brazier", "Stump Brazier",
								"Barrel Brazier", "Skull Brazier", "Marble Brazier", "Wood Lamp-post", "Iron Lamp-post", "Jack-O-Lantern",
							"Chest", "Furnace", "Scarecrow", "Seed Maker", "Staircase", "Explosive Ammo", "Transmute (Fe)", "Transmute (Au)",
								"Crystalarium", "Charcoal Kiln", "Lightning Rod", "Recycling Machine", "Tapper", "Worm Bin",
								"Slime Egg-Press", "Slime Incubator", "Warp Totem: Beach", "Warp Totem: Mountains", "Warp Totem: Farm",
								"Rain Totem", "Tub o' Flowers", "Wicked Statue", "Flute Block", "Drum Block" ];
			var recipeTranslate = {
				"Oil Of Garlic":"Oil of Garlic"
			};
			known = {};
			known_count = 0;
			craft_count = 0;
			need_k = [];
			need_c = [];
			
			$(xmlDoc).find('player > craftingRecipes > item').each(function() {
				var id = $(this).find('key > string').text();
				var num = $(this).find('value > int').text();
				if (id in recipeTranslate) {
					id = recipeTranslate[id];
				}
				known[id] = num;
				known_count++;
				if (num > 0) {
					craft_count++;
				} else {
					need_c.push('<li>' + id + '</li>');
				}
			});

			output += '<span class="result">Knows ' + known_count + ' recipes and has crafted ' + craft_count + 
				' of them (out of ' + recipes.length + ' total)</span><ul class="ach_list">\n';
			output += '<li>'
			output += (craft_count >= 15) ? '<span class="ach_yes"><span class="ach">D.I.Y.</span> Achievement (15 recipes crafted) Eligible</span>' :
				'<span class="ach_no"><span class="ach">D.I.Y.</span> Achievement (15 recipes crafted) Not Eligible</span> -- need ' + (15-craft_count) + ' more';
			output += '</li>\n<li>';
			output += (craft_count >= 30) ? '<span class="ach_yes"><span class="ach">Artisan</span> Achievement (30 recipes crafted) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Artisan</span> Achievement (30 recipes crafted) Not Eligible</span> -- need ' + (30-craft_count) + ' more';
			output += '</li>\n<li>';
			output += (craft_count >= recipe_count) ? '<span class="ach_yes"><span class="ach">Craft Master</span> Achievement (all recipes cooked) Eligible</span>' :
				'<span class="ach_no"><span class="ach">Craft Master</span> Achievement (all recipes cooked) Not Eligible</span> -- need ' + (recipes.length-craft_count) + ' more';
			output += '</li></ul>\n';
			if (craft_count < recipes.length) {
				output += '<span class="need">Left to craft:<ul>';
				
				if (need_c.length > 0) {
					output += '<li>Known Recipes<ol>' + need_c.sort().join('') + '</ol></li>\n';
				}

				if (known_count < recipes.length) {
					var need_k = [];
					for (var id in recipes) {
						var r = recipes[id];
						if (!known.hasOwnProperty(r)) {
							need_k.push('<li>' + r + '</li>');
						} 
					}
					output += '<li>Unknown Recipes<ol>' + need_k.sort().join('') + '</ol></li>';
				}
				output += '</ul></span>\n';
			}
			
			document.getElementById('out').innerHTML = output;
		};
		reader.readAsText(file);

	}
	document.getElementById('file_select').addEventListener('change', handleFileSelect, false);
	
}
</script>

</body>
</html>